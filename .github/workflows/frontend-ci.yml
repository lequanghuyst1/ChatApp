# =============================================================================
# Frontend CI/CD Pipeline
# =============================================================================
# Workflow n√†y t·ª± ƒë·ªông ki·ªÉm tra code quality, ch·∫°y tests v√† build Frontend
# m·ªói khi c√≥ code ƒë∆∞·ª£c push ho·∫∑c t·∫°o Pull Request
# =============================================================================

name: Frontend CI/CD

# ƒê·ªãnh nghƒ©a khi n√†o workflow s·∫Ω ch·∫°y
on:
  # Ch·∫°y khi push code l√™n c√°c branch sau
  push:
    branches: [main, staging]
    paths:
      # Ch·ªâ ch·∫°y khi c√≥ thay ƒë·ªïi trong Frontend ho·∫∑c workflow file
      - 'Frontend/**'
      - '.github/workflows/frontend-ci.yml'

  # Ch·∫°y khi t·∫°o Pull Request v√†o main ho·∫∑c develop
  pull_request:
    branches: [main, staging]
    paths:
      # Ch·ªâ ch·∫°y khi PR c√≥ thay ƒë·ªïi trong Frontend
      - 'Frontend/**'

  # Cho ph√©p ch·∫°y manual t·ª´ Actions tab
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to GitHub Pages?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # Job ch√≠nh: Lint, Test v√† Build
  lint-test-build:
    name: Lint, Test & Build Frontend
    runs-on: ubuntu-latest  # Ch·∫°y tr√™n Ubuntu server m·ªõi nh·∫•t

    strategy:
      matrix:
        node-version: ['20.x']

    # Thi·∫øt l·∫≠p th∆∞ m·ª•c l√†m vi·ªác m·∫∑c ƒë·ªãnh cho t·∫•t c·∫£ c√°c b∆∞·ªõc
    defaults:
      run:
        working-directory: ./Frontend

    steps:
      # B∆∞·ªõc 1: Checkout source code t·ª´ repository
      - name: Checkout code
        uses: actions/checkout@v4

      # B∆∞·ªõc 2: C√†i ƒë·∫∑t Node.js v√† c·∫•u h√¨nh cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: './Frontend/package-lock.json'

      # B∆∞·ªõc 3: C√†i ƒë·∫∑t dependencies
      # S·ª≠ d·ª•ng 'npm ci' thay v√¨ 'npm install' ƒë·ªÉ ƒë·∫£m b·∫£o c√†i ƒë·∫∑t ch√≠nh x√°c
      # theo package-lock.json v√† nhanh h∆°n trong CI environment
      - name: Install dependencies
        run: npm ci

      # B∆∞·ªõc 4: Ki·ªÉm tra code formatting v·ªõi Prettier
      # ƒê·∫£m b·∫£o code ƒë√£ ƒë∆∞·ª£c format ƒë√∫ng chu·∫©n
      - name: Check code formatting
        run: npm run format:check
        continue-on-error: true  # Kh√¥ng fail workflow n·∫øu format sai, ch·ªâ warning

      # B∆∞·ªõc 5: Ch·∫°y ESLint ƒë·ªÉ ki·ªÉm tra code style v√† quality
      # Workflow s·∫Ω fail n·∫øu c√≥ l·ªói lint (errors), warnings kh√¥ng fail
      - name: Run ESLint
        run: npm run lint

      # B∆∞·ªõc 6: Ch·∫°y t·∫•t c·∫£ unit tests v·ªõi Jest
      # Flag --ci: T·ªëi ∆∞u cho CI environment, kh√¥ng watch mode
      - name: Run tests
        run: npm run test:ci

      # B∆∞·ªõc 7: Build production bundle v·ªõi TypeScript v√† Vite
      # Ki·ªÉm tra xem code c√≥ build th√†nh c√¥ng kh√¥ng
      - name: Build project
        run: npm run build
        env:
          # Set NODE_ENV ƒë·ªÉ optimize production build
          NODE_ENV: production
          # Set GITHUB_PAGES cho build deploy l√™n GitHub Pages
          GITHUB_PAGES: ${{ github.ref == 'refs/heads/main' && 'true' || '' }}

      # B∆∞·ªõc 8: Upload build artifacts (ch·ªâ khi t·∫•t c·∫£ steps tr√™n th√†nh c√¥ng)
      # L∆∞u tr·ªØ build output ƒë·ªÉ c√≥ th·ªÉ download sau n√†y n·∫øu c·∫ßn
      - name: Upload build artifacts
        if: success()  # Ch·ªâ ch·∫°y n·∫øu t·∫•t c·∫£ steps tr∆∞·ªõc ƒë√≥ th√†nh c√¥ng
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}  # T√™n artifact v·ªõi commit SHA
          path: Frontend/dist                      # Th∆∞ m·ª•c ch·ª©a build output
          retention-days: 7                        # Gi·ªØ artifacts trong 7 ng√†y
          compression-level: 6                     # N√©n file ƒë·ªÉ ti·∫øt ki·ªám storage

  # Job deploy: Deploy l√™n GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    needs: lint-test-build  # Ph·ª• thu·ªôc v√†o job lint-test-build
    runs-on: ubuntu-latest
    # Deploy khi: push v√†o main, Pull Request, HO·∫∂C manual trigger v·ªõi deploy=true
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy == 'true')

    # C·∫•p quy·ªÅn ghi v√†o GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write

    # ƒê·∫£m b·∫£o ch·ªâ c√≥ 1 deployment ch·∫°y t·∫°i 1 th·ªùi ƒëi·ªÉm
    concurrency:
      group: "pages"
      cancel-in-progress: false

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # B∆∞·ªõc 1: Download build artifacts t·ª´ job tr∆∞·ªõc
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: ./dist

      # B∆∞·ªõc 2: Setup GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v5

      # B∆∞·ªõc 3: Upload artifacts l√™n GitHub Pages
      - name: Upload artifact to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      # B∆∞·ªõc 4: Deploy l√™n GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # B∆∞·ªõc 5: Th√¥ng b√°o deploy th√†nh c√¥ng
      - name: Deployment summary
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üöÄ Your site is live at: ${{ steps.deployment.outputs.page_url }}"
          echo "üì¶ Deployed commit: ${{ github.sha }}"
          echo "‚è∞ Deployed at: $(date)"
